name: Notify Discord on Push

on:
  push:
    branches: [ main ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate webhook secret
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [[ -z "${DISCORD_WEBHOOK:-}" ]]; then
            echo "ERROR: DISCORD_WEBHOOK is empty."
            exit 1
          fi
          if [[ ! "$DISCORD_WEBHOOK" =~ ^https://(discord\.com|discordapp\.com)/api/webhooks/ ]]; then
            echo "ERROR: DISCORD_WEBHOOK format is invalid."
            exit 1
          fi

      # â† è¿½åŠ ï¼šURLã®å‰å¾Œç©ºç™½ãƒ»æ”¹è¡Œãƒ»CRã‚’é™¤åŽ»ã—ã¦å®‰å…¨ã«å‡ºåŠ›
      - name: Prepare webhook
        id: prep
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          CLEAN=$(printf "%s" "$DISCORD_WEBHOOK" | tr -d '\r\n' | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//')
          echo "::add-mask::$CLEAN"
          echo "url=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Post to Discord
        env:
          WEBHOOK: ${{ steps.prep.outputs.url }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          PUSHER: ${{ github.actor }}
          COMPARE: ${{ github.event.compare }}
          MSG:    ${{ github.event.head_commit.message }}
          SHA:    ${{ github.sha }}
        run: |
          jq -n \
            --arg content "ðŸ“¢ Push on $REPO ($BRANCH) by $PUSHER" \
            --arg url "$COMPARE" \
            --arg msg "$MSG" \
            --arg sha "$SHA" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg pusher "$PUSHER" \
            '{
              content: $content,
              embeds: [{
                title: ("Commit " + $sha),
                url: $url,
                description: $msg,
                fields: [
                  {name:"Repository", value:$repo,   inline:true},
                  {name:"Branch",     value:$branch, inline:true},
                  {name:"Pusher",     value:$pusher, inline:true}
                ]
              }]
            }' \
          | curl -fsS -X POST -H "Content-Type: application/json" -d @- "$WEBHOOK"
