name: Notify Discord on Push

on:
  push:
    branches:
      - main  # „Éá„Éï„Ç©„É´„Éà„Éñ„É©„É≥„ÉÅ„Åå main ‰ª•Â§ñ„Å™„ÇâÂ§âÊõ¥

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # 1) jq „Çí„Ç§„É≥„Çπ„Éà„Éº„É´ÔºàJSONÁîüÊàê„Å´‰ΩøÁî®Ôºâ
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 2) Webhook Secret „ÅÆÂΩ¢Âºè„Çí‰∫ãÂâçÊ§úË®ºÔºàÁ©∫/ÂΩ¢Âºè‰∏çÊ≠£„Å™„Çâ„Åì„Åì„ÅßÊ≠¢„ÇÅ„ÇãÔºâ
      - name: Validate webhook secret
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [[ -z "${DISCORD_WEBHOOK:-}" ]]; then
            echo "ERROR: DISCORD_WEBHOOK is empty. Set it in Settings > Secrets > Actions."
            exit 1
          fi
          if [[ ! "$DISCORD_WEBHOOK" =~ ^https://(discord\.com|discordapp\.com)/api/webhooks/ ]]; then
            echo "ERROR: DISCORD_WEBHOOK format is invalid."
            exit 1
          fi

      # 3) Discord „Å∏ÈÄöÁü•
      - name: Post to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          PUSHER: ${{ github.actor }}
          COMPARE: ${{ github.event.compare }}
          MSG:    ${{ github.event.head_commit.message }}
          SHA:    ${{ github.sha }}
        run: |
          jq -n \
            --arg content "üì¢ Push on $REPO ($BRANCH) by $PUSHER" \
            --arg url "$COMPARE" \
            --arg msg "$MSG" \
            --arg sha "$SHA" \
            --arg repo "$REPO" \
            --arg branch "$BRANCH" \
            --arg pusher "$PUSHER" \
            '{
              content: $content,
              embeds: [{
                title: ("Commit " + $sha),
                url: $url,
                description: $msg,
                fields: [
                  {name:"Repository", value:$repo,   inline:true},
                  {name:"Branch",     value:$branch, inline:true},
                  {name:"Pusher",     value:$pusher, inline:true}
                ]
              }]
            }' \
          | curl -sS -X POST -H "Content-Type: application/json" -d @- "$DISCORD_WEBHOOK"
